<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Panchabyanjan Billing App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    .center {
     display: block;
     margin-left: auto;
     margin-right: auto;
}
    body { font-family: sans-serif; max-width: 500px; margin: auto; padding: 10px; }
    input, select, button { font-size: 1rem; padding: 10px; margin: 5px 0; width: 100%; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { border: 1px solid #000; padding: 6px; }
   .total-area { font-weight: bold; margin-top: 5px; border-top: 1px solid black; padding-top: 5px; text-align: right; white-space: pre-line; }
    .qr-code { text-align: center; margin-top: 10px; }
    .qr-code img { width: 100px; height: auto; margin: 0 auto; display: block; }
    .qr-label { font-size: 0.75em; margin-top: 5px; text-align: center; }
    .no-print { display: block; }
    @media print { .no-print { display: none; } }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
<img src="logo.png" alt="Panchabyanjan Logo" class="center" style="height: 100px; margin-bottom: 5px;">
<h2 style="text-align:center;">Panchabyanjan Restaurant and Caterer</h2>
<p style="text-align:center;">86 Tarafdarpara Rd, Kolkata-700151</p>
<p style="text-align:center;">Phone: 6290300741</p>
<p style="text-align:center;">Email: panchabyanrestaurant@gmail.com</p>
<p><strong>Bill No:</strong> <span id="billNumber">---</span></p>
<p id="customerDisplay"></p>
<table id="billTable"><thead><tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead><tbody></tbody></table>
<p style="text-align:right;"><strong>Subtotal:</strong> ₹<span id="subtotal">0</span></p>
<p style="text-align:right;"><strong>Tax:</strong> ₹<span id="taxAmount">0</span></p>
<p style="text-align:right;"><strong>Total:</strong> ₹<span id="grandTotal">0</span></p>
<p style="margin-top: 10px; font-size: 0.75em; text-align: center;">Thank you for your order!<br>WE ACCEPT PARTY BOOKING</p>
  </div>
<div class="qr-code">
    <div class="qr-label">Scan to Pay</div>
    <img src="WhatsApp%20Image%202025-06-23%20at%2012.23.26%20PM.jpeg" alt="UPI QR Code" />
  </div>
<div class="no-print">
  <input type="text" id="customerName" placeholder="Customer Name" />
  <input type="text" id="customerMobile" placeholder="Mobile Number" />
  <input type="number" id="tax" placeholder="Tax %" value="0" />
  <input type="text" id="menuSearch" placeholder="Search menu..." oninput="filterMenu()" />
  <select id="menuSelect" size="10"></select>
  <input type="number" id="qty" value="1" placeholder="Quantity" />
  <button onclick="addItem()">Add Item</button>
  <button onclick="addSpecialItem()">Add Special Item</button>
  <button onclick="generateBill()">Generate Bill</button>
  <button onclick="window.print()">Print</button>
  <button onclick="downloadHistoryByDateRangeCSV()">Download Bill History</button>
  <button onclick="downloadItemSalesReportCSV()">Download Item Sales</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBFLzo4TB3wvnUzzriyB3oY4Grw8FMPmXY",
  authDomain: "panchabyanjan-billing-7ca90.firebaseapp.com",
  databaseURL: "https://panchabyanjan-billing-7ca90-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "panchabyanjan-billing-7ca90",
  storageBucket: "panchabyanjan-billing-7ca90.firebasestorage.app",
  messagingSenderId: "892887228821",
  appId: "1:892887228821:web:96af9e50282ddfc672569c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

window.onload = function () {
  const menu = {
    "Shahi Paneer": 120,
      "Matar Paneer": 100,
      "Aloo Posto": 70,
      "Kasha Aloo Dum": 50,
      "Moong Dal": 60,
      "Paneer Butter Masala": 140,
      "Paneer Bhurjee": 120,
      "Fish Finger (Bhetki) - 5pcs": 160,
      "Fish Fry (Bhetki)": 180,
      "Dry Chilli Chicken - 8pcs": 150,
      "Chicken Finger - 6pcs": 120,
      "Chicken Pakora - 6pcs": 100,
      "Paneer Pakora - 6pcs": 120,
      "Egg Chicken Fried Rice": 140,
      "Veg Fried Rice": 80,
      "Egg Fried Rice": 100,
      "Chicken Fried Rice": 120,
      "Basanti Polao": 80,
      "Steamed Rice - Basmati": 70,
      "Steamed Rice - Plain": 50,
      "Roti per pc": 6,
      "Tawa Paratha per pc": 12,
      "Green Salad": 50,
      "Onion Salad": 30,
      "Chicken Thali": 120,
      "Fish Thali (Rohu)": 100,
      "Fish Thali (Katla)": 100,
      "Egg Thali": 80,
      "Veg Thali": 60,
      "Mutton Thali": 220,
      "Chilli Chicken - 4pc": 80,
      "Chilli Chicken - 8pc": 150,
      "Schezwan Chicken - 4pc": 80,
      "Schezwan Chicken - 8pc": 150,
      "Hot Garlic Chicken - 4pc": 80,
      "Hot Garlic Chicken - 8pc": 150,
      "Chicken Kasha - 2pc": 70,
      "Chicken Kasha - 4pc": 130,
      "Shahi Chicken - 2pc": 90,
      "Shahi Chicken - 4pc": 160,
      "Egg Kasha - 1pc": 30,
      "Egg Kasha - 2pc": 50,
      "Rohu Fish Curry - 1pc": 60,
      "Rohu Fish Curry - 2pc": 100,
      "Katla Fish Curry - 1pc": 90,
      "Katla Fish Curry - 2pc": 170,
      "Mutton Kasha - 2pc": 160,
      "Mutton Kasha - 4pc": 300,
      "4pcs Roti+4pcs Chicken Kasha+Salad": 130,
      "4pcs Roti+2pcs Chicken Kasha+Salad": 90,
      "4pcs Roti+4pcs Chilli Chicken": 120,
      "4pcs Roti+2pcs Chilli Chicken": 90,
      "4pcs Roti+Paneer": 120,
      "3pcs Tawa Paratha+Paneer": 120,
      "3pcs Tawa Paratha+4pcs Chicken Kasha+Salad": 150,
      "3pcs Tawa Paratha+2pcs Chicken Kasha+Salad": 120,
      "3pcs Tawa Paratha+4pcs Chilli Chicken": 120,
      "3pcs Tawa Paratha+2pcs Chilli Chicken": 90,
      "Basanti Polao+4pcs Chicken Kasha": 150,
      "Basanti Polao+2pcs Chicken Kasha": 100,
      "Basanti Polao+2pcs Egg Kasha": 100,
      "Basanti Polao+Paneer": 120,
      "Basanti Polao+4pcs Mutton Kasha": 320,
      "Basanti Polao+2pcs Mutton Kasha": 220,
      "Veg Fried Rice+4pcs Chicken Kasha": 150,
      "Veg Fried Rice+2pcs Chicken Kasha": 100,
      "Veg Fried Rice+4pcs Chilli Chicken": 140,
      "Veg Fried Rice+2pcs Chilli Chicken": 100,
      "Veg Fried Rice+Paneer": 120,
      "Egg Fried Rice+4pcs Chicken Kasha": 160,
      "Egg Fried Rice+2pcs Chicken Kasha": 120,
      "Egg Fried Rice+4pcs Chilli Chicken": 150,
      "Egg Fried Rice+2pcs Chilli Chicken": 120,
      "Egg Chicken Fried Rice+4pcs Chicken Kasha": 180,
      "Egg Chicken Fried Rice+2pcs Chicken Kasha": 150,
      "Egg Chicken Fried Rice+4pcs Chilli Chicken": 180,
      "Egg Chicken Fried Rice+2pcs Chilli Chicken": 150
  };
  const billItems = [];
  const menuSelect = document.getElementById("menuSelect");

  function renderMenu() {
    const search = document.getElementById("menuSearch").value.toLowerCase();
    menuSelect.innerHTML = "";
    Object.keys(menu).forEach(item => {
      if (item.toLowerCase().includes(search)) {
        const opt = document.createElement("option");
        opt.value = item;
        opt.textContent = `${item} - ₹${menu[item]}`;
        menuSelect.appendChild(opt);
      }
    });
  }
  window.filterMenu = renderMenu;
  renderMenu();

  window.addItem = function () {
    const item = menuSelect.value;
    const qty = parseInt(document.getElementById("qty").value);
    if (!item || !qty) return alert("Select item and quantity");
    billItems.push({ name: item, qty, rate: menu[item] });
    renderBill();
  };

  window.addSpecialItem = function () {
    const name = prompt("Enter item name:");
    const rate = parseFloat(prompt("Enter rate:"));
    const qty = parseInt(prompt("Enter qty:"));
    if (!name || !rate || !qty) return;
    billItems.push({ name, qty, rate });
    renderBill();
  };

  function renderBill() {
    const tbody = document.querySelector("#billTable tbody");
    tbody.innerHTML = "";
    let subtotal = 0;
    billItems.forEach(({ name, qty, rate }) => {
      const total = qty * rate;
      subtotal += total;
      tbody.innerHTML += `<tr><td>${name}</td><td>${qty}</td><td>${rate}</td><td>${total}</td></tr>`;
    });
    const tax = parseFloat(document.getElementById("tax").value) || 0;
    const taxAmt = subtotal * tax / 100;
    const total = subtotal + taxAmt;
    document.getElementById("subtotal").innerText = subtotal.toFixed(2);
    document.getElementById("taxAmount").innerText = taxAmt.toFixed(2);
    document.getElementById("grandTotal").innerText = total.toFixed(2);
  }

  window.generateBill = function () {
    const name = document.getElementById("customerName").value;
    const mobile = document.getElementById("customerMobile").value;
    if (!name || !mobile) return alert("Customer info required");
    document.getElementById("customerDisplay").innerText = name + " | " + mobile;

    try {
      db.ref("lastBillNo").transaction(curr => (curr || 1000) + 1).then(res => {
        const billNo = res.snapshot.val();
        document.getElementById("billNumber").innerText = billNo;
        saveAndStoreBill(billNo, name, mobile);
      }).catch(() => {
        const localBill = parseInt(localStorage.getItem("lastBill") || "1000") + 1;
        localStorage.setItem("lastBill", localBill);
        document.getElementById("billNumber").innerText = localBill;
        saveAndStoreBill(localBill, name, mobile);
      });
    } catch {
      const localBill = parseInt(localStorage.getItem("lastBill") || "1000") + 1;
      localStorage.setItem("lastBill", localBill);
      document.getElementById("billNumber").innerText = localBill;
      saveAndStoreBill(localBill, name, mobile);
    }
  };

  function saveAndStoreBill(billNo, name, mobile) {
    renderBill();
    const tax = parseFloat(document.getElementById("tax").value) || 0;
    let subtotal = 0;
    const items = billItems.map(i => {
      const total = i.qty * i.rate;
      subtotal += total;
      return `${i.name} (x${i.qty}) = ₹${total}`;
    });
    const taxAmt = subtotal * tax / 100;
    const grandTotal = subtotal + taxAmt;

    const bill = {
      billNo, date: new Date().toISOString(), name, mobile, items,
      subtotal, tax: taxAmt, total: grandTotal
    };

    const history = JSON.parse(localStorage.getItem("billHistory") || "[]");
    history.push(bill);
    localStorage.setItem("billHistory", JSON.stringify(history));
    try { db.ref("bills").push(bill); } catch {}
  }

  window.downloadHistoryByDateRangeCSV = function () {
  const from = prompt("From date (YYYY-MM-DD)");
  const to = prompt("To date (YYYY-MM-DD)");
  db.ref("bills").once("value", snapshot => {
    const allBills = snapshot.val();
    if (!allBills) return alert("No bills found in database");

    const rows = [["Bill No","Date","Customer","Mobile","Items","Subtotal","Tax","Total"]];
    Object.values(allBills).forEach(bill => {
      const date = bill.date.split("T")[0];
      if (date >= from && date <= to) {
        rows.push([
          bill.billNo,
          bill.date,
          bill.name,
          bill.mobile,
          bill.items.join(" | "),
          bill.subtotal,
          bill.tax,
          bill.total
        ]);
      }
    });

    if (rows.length === 1) return alert("No bills found in selected date range");

    const csv = rows.map(r => r.join(",")).join("\\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "bill_history.csv";
    a.click();
  });
};

  window.downloadItemSalesReportCSV = function () {
  const from = prompt("From date (YYYY-MM-DD)");
  const to = prompt("To date (YYYY-MM-DD)");
  db.ref("bills").once("value", snapshot => {
    const allBills = snapshot.val();
    if (!allBills) return alert("No bills found in database");

    const items = {};
    Object.values(allBills).forEach(bill => {
      const date = bill.date.split("T")[0];
      if (date >= from && date <= to) {
        bill.items.forEach(entry => {
          const match = entry.match(/^(.*?)\\s*\\(x(\\d+)\\)\\s*=\\s*₹?(\\d+)/);
          if (match) {
            const name = match[1].trim();
            const qty = parseInt(match[2]);
            const amt = parseFloat(match[3]);
            if (!items[name]) items[name] = { qty: 0, total: 0 };
            items[name].qty += qty;
            items[name].total += amt;
          }
        });
      }
    });

    if (Object.keys(items).length === 0) return alert("No item sales found in selected range");

    const rows = [["Item", "Qty", "Sales ₹"]];
    for (let name in items) {
      rows.push([name, items[name].qty, items[name].total.toFixed(2)]);
    }

    const csv = rows.map(r => r.join(",")).join("\\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "item_sales_report.csv";
    a.click();
  });
};
};
</script>
</body>
</html>
