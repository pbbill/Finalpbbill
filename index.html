<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBFLzo4TB3wvnUzzriyB3oY4Grw8FMPmXY",
  authDomain: "panchabyanjan-billing-7ca90.firebaseapp.com",
  databaseURL: "https://panchabyanjan-billing-7ca90-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "panchabyanjan-billing-7ca90",
  storageBucket: "panchabyanjan-billing-7ca90.firebasestorage.app",
  messagingSenderId: "892887228821",
  appId: "1:892887228821:web:96af9e50282ddfc672569c"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const user = JSON.parse(localStorage.getItem("loggedInUser"));
  if (!user) location.href = "login.html";

  document.getElementById("userInfo").textContent = `Logged in as: ${user.username} (${user.role})`;

  function logout() {
    localStorage.removeItem("loggedInUser");
    location.href = "login.html";
  }

  function checkPermissions() {
    db.ref("roles/" + user.role).once("value", snap => {
      const perms = snap.val();
      if (!perms) return;

      if (!perms.reports) {
        document.getElementById("reportViewer").style.display = "none";
      }
      if (!perms.settlement) {
        document.getElementById("settlementTab").style.display = "none";
      }
      if (!perms.admin) {
        document.getElementById("adminTools").style.display = "none";
      }
    });
  }

  window.onload = function () {
    filterMenu();
    populateReprintDropdown();
    checkPermissions();
    loadRolesToDropdown();
  };

  function filterMenu() {
    const search = document.getElementById("menuSearch").value.toLowerCase();
    const menuSelect = document.getElementById("menuSelect");
    menuSelect.innerHTML = "";
    Object.keys(menu).forEach(item => {
      if (item.toLowerCase().includes(search)) {
        const opt = document.createElement("option");
        opt.value = item;
        opt.textContent = `${item} - ₹${menu[item]}`;
        menuSelect.appendChild(opt);
      }
    });
  }

  const billItems = [];

  function addItem() {
    const item = document.getElementById("menuSelect").value;
    const qty = parseInt(document.getElementById("qty").value);
    if (!item || !qty) return alert("Select item and quantity");
    billItems.push({ name: item, qty, rate: menu[item] });
    renderBill();
  }

  function addSpecialItem() {
    const name = prompt("Item name?");
    const rate = parseFloat(prompt("Rate?"));
    const qty = parseInt(prompt("Qty?"));
    if (!name || !rate || !qty) return;
    billItems.push({ name, qty, rate });
    renderBill();
  }

  function renderBill() {
    const tbody = document.querySelector("#billTable tbody");
    tbody.innerHTML = "";
    let subtotal = 0;
    billItems.forEach(({ name, qty, rate }, index) => {
      const total = qty * rate;
      subtotal += total;
      tbody.innerHTML += `<tr><td>${name}</td><td>${qty}</td><td>${rate}</td><td>${total}</td></tr>`;
    });
    const tax = parseFloat(document.getElementById("tax").value) || 0;
    const taxAmt = subtotal * tax / 100;
    const grandTotal = subtotal + taxAmt;
    document.getElementById("subtotal").innerText = subtotal.toFixed(2);
    document.getElementById("taxAmount").innerText = taxAmt.toFixed(2);
    document.getElementById("grandTotal").innerText = grandTotal.toFixed(2);
  }

  function generateBill() {
    const name = document.getElementById("customerName").value;
    const mobile = document.getElementById("customerMobile").value;
    if (!name || !mobile) return alert("Customer info required");

    db.ref("lastBillNo").transaction(curr => (curr || 1000) + 1).then(res => {
      const billNo = res.snapshot.val();
      document.getElementById("billNumber").innerText = billNo;
      saveBill(billNo, name, mobile);
    });
  }

  function saveBill(billNo, name, mobile) {
    const tax = parseFloat(document.getElementById("tax").value) || 0;
    let subtotal = 0;
    const items = billItems.map(i => {
      const total = i.qty * i.rate;
      subtotal += total;
      return `${i.name} (x${i.qty}) = ₹${total}`;
    });
    const taxAmt = subtotal * tax / 100;
    const total = subtotal + taxAmt;

    const bill = {
      billNo,
      name,
      mobile,
      date: new Date().toISOString(),
      items,
      subtotal,
      tax: taxAmt,
      total,
      paymentMode: "Unpaid"
    };
    db.ref("bills").push(bill);
    generateKOT(billNo, items);
  }

  function generateKOT(billNo, items) {
    const kotNo = "KOT" + Date.now();
    const kot = {
      kotNo,
      billNo,
      items,
      createdAt: new Date().toISOString()
    };
    db.ref("kots").push(kot);
  }

  function printAndReset() {
    window.onafterprint = () => {
      billItems.length = 0;
      document.querySelector("#billTable tbody").innerHTML = "";
      ["customerName", "customerMobile", "menuSearch", "qty", "tax"].forEach(id => {
        document.getElementById(id).value = "";
      });
      ["subtotal", "taxAmount", "grandTotal", "billNumber", "customerDisplay"].forEach(id => {
        document.getElementById(id).innerText = id === "billNumber" ? "---" : "0";
      });
      filterMenu();
    };
    window.print();
  }

  function populateReprintDropdown() {
    db.ref("bills").once("value", snap => {
      const all = snap.val();
      const select = document.getElementById("reprintSelect");
      select.innerHTML = "<option value=''>Select Bill</option>";
      Object.entries(all || {}).forEach(([key, bill]) => {
        select.innerHTML += `<option value="${key}">#${bill.billNo} - ${bill.name}</option>`;
      });
    });
  }

  function loadAndPrintBill() {
    const key = document.getElementById("reprintSelect").value;
    if (!key) return;
    db.ref("bills/" + key).once("value", snap => {
      const bill = snap.val();
      if (!bill) return;
      document.getElementById("billNumber").innerText = bill.billNo;
      document.getElementById("customerDisplay").innerText = bill.name + " | " + bill.mobile;
      const tbody = document.querySelector("#billTable tbody");
      tbody.innerHTML = "";
      (bill.items || []).forEach(line => {
        const match = line.match(/^(.*?) \(x(\d+)\) = ₹(\d+)/);
        if (match) {
          const name = match[1], qty = match[2], rate = match[3] / qty;
          tbody.innerHTML += `<tr><td>${name}</td><td>${qty}</td><td>${rate}</td><td>${rate * qty}</td></tr>`;
        }
      });
      document.getElementById("subtotal").innerText = bill.subtotal.toFixed(2);
      document.getElementById("taxAmount").innerText = bill.tax.toFixed(2);
      document.getElementById("grandTotal").innerText = bill.total.toFixed(2);
      setTimeout(() => window.print(), 500);
    });
  }

  // === Role & User Management ===
  function loadRolesToDropdown() {
    db.ref("roles").once("value", snap => {
      const all = snap.val() || {};
      const dropdown = document.getElementById("assignRoleDropdown");
      dropdown.innerHTML = "<option value=''>Select Role</option>";
      Object.keys(all).forEach(r => {
        dropdown.innerHTML += `<option value="${r}">${r}</option>`;
      });

      const permBox = document.getElementById("permissionCheckboxes");
      if (permBox) {
        permBox.innerHTML = `
          <label><input type="checkbox" id="perm_billing" /> Billing</label><br>
          <label><input type="checkbox" id="perm_reports" /> Reports</label><br>
          <label><input type="checkbox" id="perm_settlement" /> Settlement</label><br>
          <label><input type="checkbox" id="perm_admin" /> Admin</label><br>
        `;
      }
    });

    // Load existing users
    db.ref("users").once("value", snap => {
      const all = snap.val() || {};
      const userList = document.getElementById("userList");
      if (userList) {
        userList.innerHTML = "<h4>All Users</h4>";
        Object.entries(all).forEach(([k, u]) => {
          userList.innerHTML += `<p>${u.username} — Role: ${u.role}</p>`;
        });
      }
    });

    // Load existing roles
    db.ref("roles").once("value", snap => {
      const all = snap.val() || {};
      const roleList = document.getElementById("roleList");
      if (roleList) {
        roleList.innerHTML = "<h4>All Roles</h4>";
        Object.entries(all).forEach(([k, perms]) => {
          roleList.innerHTML += `<p>${k}: ${Object.keys(perms).join(", ")}</p>`;
        });
      }
    });
  }

  function createUser() {
    const username = document.getElementById("newUsername").value;
    const password = document.getElementById("newPassword").value;
    const role = document.getElementById("assignRoleDropdown").value;
    if (!username || !password || !role) return alert("All fields required");
    db.ref("users").push({ username, password, role }, err => {
      if (err) alert("Failed to create user");
      else {
        alert("User added");
        loadRolesToDropdown();
      }
    });
  }

  function createRole() {
    const role = document.getElementById("newRoleName").value;
    if (!role) return alert("Role name required");
    const perms = {
      billing: document.getElementById("perm_billing").checked,
      reports: document.getElementById("perm_reports").checked,
      settlement: document.getElementById("perm_settlement").checked,
      admin: document.getElementById("perm_admin").checked,
    };
    db.ref("roles/" + role).set(perms, err => {
      if (err) alert("Error saving role");
      else {
        alert("Role added");
        loadRolesToDropdown();
      }
    });
  }
</script>
</html>
