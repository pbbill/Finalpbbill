<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Panchabyanjan Billing App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
       body { font-family: sans-serif, monospace; margin: 0; padding: 10px; width: 2.8in; background: #fff; color: #000; }
    .header, .bill-summary { text-align: center; }
    .header h2 { margin: 0; font-size: 1em; white-space: nowrap; }
    .header p { margin: 2px 0; font-size: 0.8em; }
    .field-group { font-size: 0.8em; margin-bottom: 4px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.75em; }
    th, td { border-top: 1px dashed #000; padding: 2px 0; text-align: left; }
 .total-area { font-weight: bold; margin-top: 5px; border-top: 1px solid black; padding-top: 5px; text-align: right; white-space: pre-line; }
.qr-code { text-align: center; margin-top: 10px; }
    .qr-code img { width: 100px; height: auto; margin: 0 auto; display: block; }
    .qr-label { font-size: 0.75em; margin-top: 5px; text-align: center; }
    .no-print { display: block; margin: 10px 0; }
    @media print { .no-print { display: none; } }
    select, input { width: 100%; margin: 5px 0; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
  <div class="header">
    <h2>Panchabyanjan Restaurant and Caterer</h2>
    <p>86 Tarafdarpara Rd, Kolkata, 700151</p>
    <p>Phone: 6290300741</p>
    <p>Email: panchabyanrestaurant@gmail.com</p>
    <p><strong>Bill No: <span id="billNumber"></span></strong></p>
  </div>

  <div class="field-group">
    <label>Bill To: <span id="customerDisplay"></span></label>
  </div>

  <table id="billTable">
    <thead>
      <tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="total-area" id="totalDisplay"></div>

  <div class="bill-summary">
        <p><strong>Subtotal:</strong> ₹<span id="subtotal">0</span></p>
  <p><strong>Tax:</strong> ₹<span id="taxAmount">0</span></p>
  <p><strong>Total:</strong> ₹<span id="grandTotal">0</span></p>
<p style="margin-top: 10px; font-size: 0.75em; text-align: center;">Thank you for your order!<br>WE ACCEPT PARTY BOOKING</p>
  </div>
<div class="qr-code">
    <div class="qr-label">Scan to Pay</div>
    <img src="WhatsApp%20Image%202025-06-23%20at%2012.23.26%20PM.jpeg" alt="UPI QR Code" />
  </div>
  <div class="no-print">
    <input type="text" id="customerName" placeholder="Customer Name" />
    <input type="text" id="customerMobile" placeholder="Mobile Number" />
    <input type="number" id="tax" placeholder="Tax %" value="0" />
    <input type="text" id="menuSearch" placeholder="Search menu..." oninput="filterMenu()" />
    <select id="menuSelect" size="10"></select>
    <input type="number" id="qty" placeholder="Quantity" value="1" />
    <button onclick="addItem()">Add Item</button>
    <button onclick="addSpecialItem()">Add Special Item</button>
    <button onclick="generateBill()">Generate Bill</button>
    <button onclick="window.print()">Print</button>
    <button onclick="downloadHistoryByDateRangeCSV()">Download History (Date Range)</button>
    <button onclick="downloadItemSalesReportCSV()">Item Sales Report</button>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBFLzo4TB3wvnUzzriyB3oY4Grw8FMPmXY",
  authDomain: "panchabyanjan-billing-7ca90.firebaseapp.com",
  databaseURL: "https://panchabyanjan-billing-7ca90-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "panchabyanjan-billing-7ca90",
  storageBucket: "panchabyanjan-billing-7ca90.firebasestorage.app",
  messagingSenderId: "892887228821",
  appId: "1:892887228821:web:96af9e50282ddfc672569c"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

window.onload = function () {
  const menu = {
    "Paneer Butter Masala": 140, "Veg Fried Rice": 80, "Chilli Chicken": 150, "Shahi Paneer": 120,
    "Matar Paneer": 100, "Aloo Posto": 70, "Kasha Aloo Dum": 50, "Moong Dal": 60, "Paneer Bhurjee": 120,
    "Fish Fry (Bhetki)": 180, "Dry Chilli Chicken - 8pcs": 150, "Chicken Finger - 6pcs": 120,
    "Chicken Pakora - 6pcs": 100, "Paneer Pakora - 6pcs": 120, "Basanti Polao": 80,
    "Steamed Rice - Basmati": 70, "Steamed Rice - Plain": 50, "Roti per pc": 6,
    "Tawa Paratha per pc": 12, "Green Salad": 50, "Onion Salad": 30,
    "Chicken Thali": 120, "Fish Thali (Rohu)": 100, "Fish Thali (Katla)": 100,
    "Egg Thali": 80, "Veg Thali": 60, "Mutton Thali": 220
  };
  const billItems = [];

  const menuSelect = document.getElementById("menuSelect");
  const qtyInput = document.getElementById("qty");

  window.filterMenu = function () {
    const search = document.getElementById("menuSearch").value.toLowerCase();
    menuSelect.innerHTML = "";
    Object.keys(menu).forEach(item => {
      if (item.toLowerCase().includes(search)) {
        const option = document.createElement("option");
        option.value = item;
        option.textContent = `${item} - ₹${menu[item]}`;
        menuSelect.appendChild(option);
      }
    });
  };

  filterMenu();

  window.addItem = function () {
    const item = menuSelect.value;
    const qty = parseInt(qtyInput.value);
    if (!item || !qty) return alert("Select item and quantity");
    billItems.push({ name: item, qty, rate: menu[item] });
    renderBill();
  };

  window.addSpecialItem = function () {
    const name = prompt("Enter item name:");
    const rate = parseFloat(prompt("Enter rate:"));
    const qty = parseInt(prompt("Enter qty:"));
    if (!name || !rate || !qty) return;
    billItems.push({ name, qty, rate });
    renderBill();
  };

  function renderBill() {
    const tbody = document.querySelector("#billTable tbody");
    tbody.innerHTML = "";
    let subtotal = 0;
    billItems.forEach(({ name, qty, rate }) => {
      const total = qty * rate;
      subtotal += total;
      tbody.innerHTML += `<tr><td>${name}</td><td>${qty}</td><td>${rate}</td><td>${total}</td></tr>`;
    });
    const tax = parseFloat(document.getElementById("tax").value) || 0;
    const taxAmt = subtotal * (tax / 100);
    const total = subtotal + taxAmt;
    document.getElementById("subtotal").innerText = subtotal.toFixed(2);
    document.getElementById("taxAmount").innerText = taxAmt.toFixed(2);
    document.getElementById("grandTotal").innerText = total.toFixed(2);
  }

  function saveLastBillNumber() {
    const last = parseInt(localStorage.getItem("lastBill") || "1000") + 1;
    localStorage.setItem("lastBill", last);
    document.getElementById("billNumber").innerText = last;
  }

  window.generateBill = function () {
    const name = document.getElementById("customerName").value;
    const mobile = document.getElementById("customerMobile").value;
    if (!name || !mobile) return alert("Customer info required");
    document.getElementById("customerDisplay").innerText = name + " | " + mobile;
    saveLastBillNumber();
    renderBill();

    const tax = parseFloat(document.getElementById("tax").value) || 0;
    let subtotal = 0;
    const items = billItems.map(i => {
      const total = i.qty * i.rate;
      subtotal += total;
      return `${i.name} (x${i.qty}) = ₹${total}`;
    });
    const taxAmount = subtotal * tax / 100;
    const total = subtotal + taxAmount;

    const bill = {
      billNo: document.getElementById("billNumber").innerText,
      date: new Date().toISOString(),
      name,
      mobile,
      items,
      subtotal,
      tax: taxAmount,
      total
    };

    const history = JSON.parse(localStorage.getItem("billHistory") || "[]");
    history.push(bill);
    localStorage.setItem("billHistory", JSON.stringify(history));

    db.ref("bills").push(bill);
  };

  window.downloadHistoryByDateRangeCSV = function () {
    const from = prompt("From date (YYYY-MM-DD)");
    const to = prompt("To date (YYYY-MM-DD)");
    const history = JSON.parse(localStorage.getItem("billHistory") || "[]");
    const filtered = history.filter(b => b.date.split("T")[0] >= from && b.date.split("T")[0] <= to);
    if (filtered.length === 0) return alert("No bills found");
    const rows = [["Bill No","Date","Customer","Mobile","Items","Subtotal","Tax","Total"]];
    filtered.forEach(b => {
      rows.push([b.billNo, b.date, b.name, b.mobile, b.items.join(" | "), b.subtotal, b.tax, b.total]);
    });
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "bill_history.csv";
    a.click();
  };

  window.downloadItemSalesReportCSV = function () {
    const from = prompt("From date (YYYY-MM-DD)");
    const to = prompt("To date (YYYY-MM-DD)");
    const history = JSON.parse(localStorage.getItem("billHistory") || "[]");
    const filtered = history.filter(b => b.date.split("T")[0] >= from && b.date.split("T")[0] <= to);
    const items = {};
    filtered.forEach(bill => {
      bill.items.forEach(str => {
        const match = str.match(/^(.*?)\s*\(x(\d+)\)\s*=\s*₹?(\d+)/);
        if (match) {
          const name = match[1].trim();
          const qty = parseInt(match[2]);
          const amt = parseFloat(match[3]);
          if (!items[name]) items[name] = { qty: 0, total: 0 };
          items[name].qty += qty;
          items[name].total += amt;
        }
      });
    });
    if (Object.keys(items).length === 0) return alert("No item sales found");
    const rows = [["Item", "Qty", "Sales ₹"]];
    for (let name in items) {
      rows.push([name, items[name].qty, items[name].total.toFixed(2)]);
    }
    const csv = rows.map(r => r.join(",")).join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "item_sales_report.csv";
    a.click();
  };
};
</script>
</body>
</html>